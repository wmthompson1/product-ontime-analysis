{
  "timestamp": "2025-08-29T01:52:38.274008",
  "test_cases": 6,
  "standard_layer_results": [
    {
      "test_id": "supply_chain_001",
      "query": "Show suppliers with delivery performance issues affecting production",
      "generated_sql": "```sql SELECT s.supplier_id, s.supplier_name, AVG(d.ontime_rate) AS average_ontime_rate FROM suppliers s JOIN daily_deliveries d ON s.supplier_id = d.supplier_id GROUP BY s.supplier_id, s.supplier_name HAVING AVG(d.ontime_rate) < %s ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": " This query joins the suppliers and daily_deliveries tables on the supplier_id field. It then groups the results by supplier_id and supplier_name, and calculates the average ontime_rate for each supplier. The HAVING clause filters out suppliers with an average ontime_rate of 95% or higher, as per the industry standard for On-Time Delivery (OTD). The result is a list of suppliers with delivery performance issues that could be affecting production.",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "quality_001",
      "query": "Find products with NCM rates trending above industry standards",
      "generated_sql": "```sql WITH defect_trend AS ( SELECT product_line, AVG(defect_rate) OVER (PARTITION BY product_line ORDER BY production_date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS moving_average_defect_rate FROM product_defects WHERE defect_type = %s ) SELECT dt.product_line, dt.moving_average_defect_rate FROM defect_trend dt WHERE dt.moving_average_defect_rate > %s ORDER BY dt.moving_average_defect_rate DESC ```",
      "confidence": 0.9,
      "safety_check": true,
      "explanation": " This query first creates a CTE (Common Table Expression) named 'defect_trend' that calculates the moving average of the defect rate for each product line over a window of the current and the preceding 6 days (one week). This is done using the AVG() function with an OVER clause to specify the window, and the PARTITION BY clause to calculate this separately for each product line. The WHERE clause in the CTE filters for defects of type 'NCM'. The main SELECT statement then filters the results of the CTE for product lines where the moving average defect rate is greater than the industry standard of 2.5% (0.025). The results are ordered in descending order of the defect rate.",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "production_001",
      "query": "Calculate OEE for critical equipment showing downtime patterns",
      "generated_sql": "```sql WITH critical_equipment AS ( SELECT equipment_id, measurement_date, availability_rate * performance_rate * quality_rate AS oee, downtime_hours FROM equipment_metrics WHERE equipment_type = %s ), downtime_pattern AS ( SELECT equipment_id, measurement_date, oee, downtime_hours, LAG(downtime_hours) OVER (PARTITION BY equipment_id ORDER BY measurement_date) AS previous_downtime FROM critical_equipment ) SELECT equipment_id, measurement_date, oee, downtime_hours, COALESCE(downtime_hours - previous_downtime, 0) AS downtime_change FROM downtime_pattern ORDER BY equipment_id, measurement_date; ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": " The query first filters the equipment_metrics table for only critical equipment and calculates the OEE for each piece of equipment. Then, it calculates the change in downtime from the previous measurement date for each piece of equipment. The result is a list of critical equipment with their OEE and change in downtime for each measurement date.",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "financial_001",
      "query": "Show cost impact of quality issues by product line",
      "generated_sql": "```sql SELECT product_line, SUM(cost_impact) AS total_cost_impact FROM non_conformant_materials GROUP BY product_line ORDER BY total_cost_impact DESC; ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "This query calculates the total cost impact of quality issues for each product line. It does this by summing the cost impact for each product line in the non_conformant_materials table. The results are then ordered in descending order by the total cost impact.",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "maintenance_001",
      "query": "Find equipment with MTBF below target requiring immediate attention",
      "generated_sql": "```sql SELECT er.equipment_id, er.mtbf_hours, er.target_mtbf FROM equipment_reliability er WHERE er.mtbf_hours < er.target_mtbf ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "This query selects the equipment_id, mtbf_hours, and target_mtbf from the equipment_reliability table where the mtbf_hours is less than the target_mtbf. This will return all equipment where the Mean Time Between Failures (MTBF) is below the target, indicating that these pieces of equipment require immediate attention.",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "compliance_001",
      "query": "Show CAPA effectiveness for recurring quality issues",
      "generated_sql": "```sql WITH recurring_issues AS ( SELECT ncm_id, COUNT(*) AS recurrence_count FROM non_conformant_materials GROUP BY ncm_id HAVING COUNT(*) > 1 ), capa_effectiveness AS ( SELECT ca.ncm_id, AVG(ca.effectiveness_score) AS avg_effectiveness FROM corrective_actions ca JOIN recurring_issues ri ON ca.ncm_id = ri.ncm_id GROUP BY ca.ncm_id ) SELECT ri.ncm_id, ri.recurrence_count, ce.avg_effectiveness FROM recurring_issues ri JOIN capa_effectiveness ce ON ri.ncm_id = ce.ncm_id ORDER BY ri.recurrence_count DESC, ce.avg_effectiveness ASC; ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": " This query first identifies recurring quality issues by counting the number of times each NCM incident ID appears in the non_conformant_materials table. It then calculates the average effectiveness score for each NCM incident ID in the corrective_actions table. The final SELECT statement joins these two derived tables on the NCM incident ID and returns the NCM incident ID, recurrence count, and average effectiveness score. The results are ordered by recurrence count in descending order and average effectiveness score in ascending order.",
      "complexity": "QueryComplexity.SIMPLE"
    }
  ],
  "advanced_layer_results": [
    {
      "test_id": "supply_chain_001",
      "query": "Show suppliers with delivery performance issues affecting production",
      "generated_sql": "SELECT \n    s.supplier_name,\n    COUNT(d.delivery_id) as total_deliveries,\n    AVG(d.ontime_rate) as avg_ontime_rate,\n    COUNT(ps.schedule_id) as affected_production_schedules\nFROM suppliers s\nJOIN daily_deliveries d ON s.supplier_id = d.supplier_id\nJOIN production_schedule ps ON ps.line_id = d.supplier_id AND ps.planned_start::date = d.date\nWHERE d.ontime_rate < 0.95 AND d.date >= CURRENT_DATE - INTERVAL '90 days'\nGROUP BY s.supplier_id, s.supplier_name\nHAVING COUNT(ps.schedule_id) > 0\nORDER BY affected_production_schedules DESC, avg_ontime_rate ASC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "quality_001",
      "query": "Find products with NCM rates trending above industry standards",
      "generated_sql": "SELECT \n        product_line,\n        DATE_TRUNC('month', production_date) as month,\n        AVG(defect_rate) as monthly_ncm_rate\n    FROM product_defects\n    WHERE defect_type = 'NCM' AND production_date >= CURRENT_DATE - INTERVAL '6 months'\n    GROUP BY product_line, DATE_TRUNC('month', production_date)\n),\ntrend_analysis AS (\n    SELECT \n        product_line,\n        month,\n        monthly_ncm_rate,\n        LAG(monthly_ncm_rate) OVER (PARTITION BY product_line ORDER BY month) as prev_month_rate\n    FROM monthly_ncm\n)\nSELECT \n    product_line,\n    COUNT(*) as months_analyzed,\n    AVG(monthly_ncm_rate) as avg_ncm_rate,\n    (monthly_ncm_rate - prev_month_rate) as trend_change\nFROM trend_analysis\nWHERE prev_month_rate IS NOT NULL\n    AND monthly_ncm_rate > prev_month_rate\n    AND monthly_ncm_rate > 0.025\nGROUP BY product_line, monthly_ncm_rate, prev_month_rate\nHAVING COUNT(*) >= 2\nORDER BY trend_change DESC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "production_001",
      "query": "Calculate OEE for critical equipment showing downtime patterns",
      "generated_sql": "SELECT \n    em.equipment_name,\n    em.equipment_type,\n    AVG(em.availability_rate) as availability,\n    AVG(em.performance_rate) as performance,\n    AVG(em.quality_rate) as quality,\n    (AVG(em.availability_rate) * AVG(em.performance_rate) * AVG(em.quality_rate)) as oee_score,\n    SUM(em.downtime_hours) as total_downtime,\n    COUNT(fe.failure_id) as failure_count\nFROM equipment_metrics em\nLEFT JOIN failure_events fe ON em.equipment_id = fe.equipment_id\nWHERE em.measurement_date >= CURRENT_DATE - INTERVAL '30 days'\n    AND em.equipment_type = 'Critical'\nGROUP BY em.equipment_id, em.equipment_name, em.equipment_type\nHAVING SUM(em.downtime_hours) > 0\nORDER BY oee_score ASC, total_downtime DESC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "financial_001",
      "query": "Show cost impact of quality issues by product line",
      "generated_sql": "SELECT \n    pd.product_line,\n    COUNT(ncm.ncm_id) as ncm_count,\n    SUM(ncm.cost_impact) as total_cost_impact,\n    AVG(ncm.cost_impact) as avg_cost_per_ncm\nFROM product_defects pd\nJOIN non_conformant_materials ncm ON pd.product_line = ncm.product_line\nWHERE ncm.incident_date >= CURRENT_DATE - INTERVAL '1 year'\nGROUP BY pd.product_line\nORDER BY total_cost_impact DESC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "maintenance_001",
      "query": "Find equipment with MTBF below target requiring immediate attention",
      "generated_sql": "SELECT 'Query generation failed' as status, %s as error_message",
      "confidence": 0.0,
      "safety_check": false,
      "explanation": "Could not generate SQL: OpenAI API error: Error code: 429 - {'error': {'message': 'Rate limit reached for gpt-4 in organization org-b425UEwcupCx9XWqacorsBi9 on tokens per min (TPM): Limit 10000, Used 8571, Requested 3137. Please try again in 10.248s. Visit https://platform.openai.com/account/rate-limits to learn more.', 'type': 'tokens', 'param': None, 'code': 'rate_limit_exceeded'}}",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "compliance_001",
      "query": "Show CAPA effectiveness for recurring quality issues",
      "generated_sql": "SELECT 'Query generation failed' as status, %s as error_message",
      "confidence": 0.0,
      "safety_check": false,
      "explanation": "Could not generate SQL: OpenAI API error: Error code: 429 - {'error': {'message': 'Rate limit reached for gpt-4 in organization org-b425UEwcupCx9XWqacorsBi9 on tokens per min (TPM): Limit 10000, Used 8318, Requested 3072. Please try again in 8.34s. Visit https://platform.openai.com/account/rate-limits to learn more.', 'type': 'tokens', 'param': None, 'code': 'rate_limit_exceeded'}}",
      "complexity": "QueryComplexity.SIMPLE"
    }
  ],
  "performance_comparison": {
    "success_rates": {
      "standard": 1.0,
      "advanced": 0.6666666666666666
    },
    "average_confidence": {
      "standard": 0.9833333333333334,
      "advanced": 1.0
    },
    "complexity_distribution": {
      "standard": {
        "QueryComplexity.SIMPLE": 5,
        "QueryComplexity.MEDIUM": 1
      },
      "advanced": {
        "QueryComplexity.MEDIUM": 4
      }
    },
    "safety_compliance": {
      "standard": 1.0,
      "advanced": 0.6666666666666666
    },
    "improvement_metrics": {
      "success_rate_improvement": -0.33333333333333337,
      "confidence_improvement": 0.01694915254237282
    }
  }
}