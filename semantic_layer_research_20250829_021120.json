{
  "timestamp": "2025-08-29T02:08:31.221303",
  "test_cases": 6,
  "standard_layer_results": [
    {
      "test_id": "supply_chain_001",
      "query": "Show suppliers with delivery performance issues affecting production",
      "generated_sql": "```sql SELECT s.supplier_id, s.supplier_name, AVG(d.ontime_rate) AS average_ontime_rate FROM suppliers s JOIN daily_deliveries d ON s.supplier_id = d.supplier_id GROUP BY s.supplier_id, s.supplier_name HAVING AVG(d.ontime_rate) < %s ORDER BY average_ontime_rate ASC LIMIT %s; ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": " This query joins the suppliers and daily_deliveries tables on the supplier_id field. It then groups the results by supplier_id and supplier_name, and calculates the average ontime_rate for each supplier. The HAVING clause filters out suppliers with an average ontime_rate of 95% or higher, as per the industry standard for OTD (On-Time Delivery). The results are ordered by average_ontime_rate in ascending order, so suppliers with the worst delivery performance are shown first. The query is limited to the top 100 results for performance reasons.",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "quality_001",
      "query": "Find products with NCM rates trending above industry standards",
      "generated_sql": "```sql WITH product_ncm_rate AS ( SELECT pd.product_line, AVG(pd.defect_rate) AS avg_defect_rate FROM product_defects pd WHERE pd.defect_type = %s GROUP BY pd.product_line ), industry_standard AS ( SELECT ib.benchmark_value FROM industry_benchmarks ib WHERE ib.metric_name = %s AND ib.benchmark_class = %s ) SELECT pnr.product_line, pnr.avg_defect_rate FROM product_ncm_rate pnr, industry_standard is WHERE pnr.avg_defect_rate > is.benchmark_value ORDER BY pnr.avg_defect_rate DESC LIMIT %s; ```",
      "confidence": 0.9,
      "safety_check": true,
      "explanation": " This query first creates a CTE (Common Table Expression) named 'product_ncm_rate' that calculates the average defect rate for each product line where the defect type is 'NCM'. Another CTE 'industry_standard' is created to get the industry standard value for 'NCM Rate'. Then it joins these two CTEs and selects the product lines where the average defect rate is greater than the industry standard. The result is ordered by the average defect rate in descending order. The LIMIT clause is used to prevent resource exhaustion.",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "production_001",
      "query": "Calculate OEE for critical equipment showing downtime patterns",
      "generated_sql": "```sql SELECT equipment_name, measurement_date, availability_rate * performance_rate * quality_rate AS oee, downtime_hours FROM equipment_metrics WHERE equipment_type = %s ORDER BY measurement_date; ```",
      "confidence": 0.85,
      "safety_check": true,
      "explanation": " This query selects the equipment name, measurement date, calculates the OEE (Overall Equipment Effectiveness) by multiplying the availability rate, performance rate, and quality rate, and also selects the downtime hours from the equipment_metrics table. The query only considers rows where the equipment type is 'Critical'. The results are ordered by the measurement date to show the pattern over time. 1.0",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "financial_001",
      "query": "Show cost impact of quality issues by product line",
      "generated_sql": "```sql SELECT product_line, SUM(cost_impact) AS total_cost_impact FROM non_conformant_materials GROUP BY product_line ORDER BY total_cost_impact DESC; ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": " This query calculates the total cost impact of quality issues for each product line. It does this by summing the cost impact for each product line in the non_conformant_materials table. The results are then ordered in descending order by the total cost impact.",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "maintenance_001",
      "query": "Find equipment with MTBF below target requiring immediate attention",
      "generated_sql": "```sql SELECT er.equipment_id, em.equipment_name, er.mtbf_hours, er.target_mtbf FROM equipment_reliability er JOIN equipment_metrics em ON er.equipment_id = em.equipment_id WHERE er.mtbf_hours < er.target_mtbf; ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "This query joins the equipment_reliability and equipment_metrics tables on the equipment_id column. It then selects the equipment_id, equipment_name, mtbf_hours, and target_mtbf where the mtbf_hours is less than the target_mtbf. This will return all equipment where the Mean Time Between Failures (MTBF) is below the target, indicating that these pieces of equipment require immediate attention.",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "compliance_001",
      "query": "Show CAPA effectiveness for recurring quality issues",
      "generated_sql": "```sql WITH recurring_issues AS ( SELECT ncm_id, COUNT(*) as recurrence_count FROM non_conformant_materials GROUP BY ncm_id HAVING COUNT(*) > 1 ), capa_effectiveness AS ( SELECT ca.ncm_id, AVG(ca.effectiveness_score) as avg_effectiveness_score FROM corrective_actions ca JOIN recurring_issues ri ON ca.ncm_id = ri.ncm_id GROUP BY ca.ncm_id ) SELECT ri.ncm_id, ri.recurrence_count, ce.avg_effectiveness_score FROM recurring_issues ri JOIN capa_effectiveness ce ON ri.ncm_id = ce.ncm_id ORDER BY ri.recurrence_count DESC, ce.avg_effectiveness_score ASC; ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": " This query first identifies the recurring quality issues by counting the number of times each NCM incident ID appears in the non_conformant_materials table. It then calculates the average effectiveness score for each NCM incident ID from the corrective_actions table. Finally, it joins these two results on the NCM incident ID and orders the result by the recurrence count in descending order and the average effectiveness score in ascending order. This will show the CAPA effectiveness for recurring quality issues, with the most frequently recurring issues and least effective corrective actions at the top.",
      "complexity": "QueryComplexity.SIMPLE"
    }
  ],
  "advanced_layer_results": [
    {
      "test_id": "supply_chain_001",
      "query": "Show suppliers with delivery performance issues affecting production",
      "generated_sql": "SELECT \n    s.supplier_name,\n    COUNT(d.delivery_id) as total_deliveries,\n    AVG(d.ontime_rate) as avg_ontime_rate,\n    COUNT(ps.schedule_id) as affected_production_schedules\nFROM suppliers s\nJOIN daily_deliveries d ON s.supplier_id = d.supplier_id\nJOIN production_schedule ps ON ps.line_id = d.supplier_id\nWHERE d.ontime_rate < 0.95 AND ps.actual_start IS NULL\nGROUP BY s.supplier_name\nORDER BY affected_production_schedules DESC, avg_ontime_rate ASC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "quality_001",
      "query": "Find products with NCM rates trending above industry standards",
      "generated_sql": "SELECT \n    pq.product_line,\n    AVG(pq.defect_rate) as avg_ncm_rate,\n    ib.benchmark_value as industry_standard,\n    CASE \n        WHEN AVG(pq.defect_rate) > ib.benchmark_value THEN 'Above Standard'\n        ELSE 'Below Standard'\n    END as performance_against_standard\nFROM production_quality pq\nJOIN industry_benchmarks ib ON ib.metric_name = 'NCM Rate'\nWHERE pq.production_date >= CURRENT_DATE - INTERVAL '6 months'\nGROUP BY pq.product_line, ib.benchmark_value\nHAVING AVG(pq.defect_rate) > ib.benchmark_value\nORDER BY avg_ncm_rate DESC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "production_001",
      "query": "Calculate OEE for critical equipment showing downtime patterns",
      "generated_sql": "SELECT \n    em.equipment_name,\n    em.equipment_type,\n    AVG(em.availability_rate) as availability,\n    AVG(em.performance_rate) as performance,\n    AVG(em.quality_rate) as quality,\n    (AVG(em.availability_rate) * AVG(em.performance_rate) * AVG(em.quality_rate)) as oee_score,\n    AVG(em.downtime_hours) as avg_downtime_hours,\n    COUNT(*) FILTER (WHERE em.downtime_hours > 0) as downtime_occurrences\nFROM equipment_metrics em\nWHERE em.measurement_date >= CURRENT_DATE - INTERVAL '30 days'\n    AND em.equipment_type = 'Critical'\nGROUP BY em.equipment_id, em.equipment_name, em.equipment_type\nHAVING COUNT(*) FILTER (WHERE em.downtime_hours > 0) > 1\nORDER BY oee_score ASC, avg_downtime_hours DESC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "financial_001",
      "query": "Show cost impact of quality issues by product line",
      "generated_sql": "SELECT \n    pd.product_line,\n    SUM(pd.defect_count) as total_defects,\n    AVG(pd.defect_rate) as avg_defect_rate,\n    SUM(ncm.cost_impact) as total_cost_impact\nFROM product_defects pd\nJOIN non_conformant_materials ncm ON pd.product_line = ncm.product_line\nWHERE pd.production_date >= CURRENT_DATE - INTERVAL '90 days'\nGROUP BY pd.product_line\nORDER BY total_cost_impact DESC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "maintenance_001",
      "query": "Find equipment with MTBF below target requiring immediate attention",
      "generated_sql": "SELECT \n    em.equipment_name,\n    er.mtbf_hours,\n    er.target_mtbf,\n    er.failure_count,\n    er.operating_hours,\n    er.reliability_score,\n    CASE \n        WHEN er.mtbf_hours < er.target_mtbf THEN 'Below Target'\n        ELSE 'On Target'\n    END as mtbf_status\nFROM equipment_reliability er\nJOIN equipment_metrics em ON er.equipment_id = em.equipment_id\nWHERE er.measurement_period >= CURRENT_DATE - INTERVAL '30 days'\n    AND er.mtbf_hours < er.target_mtbf\nORDER BY er.mtbf_hours ASC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "compliance_001",
      "query": "Show CAPA effectiveness for recurring quality issues",
      "generated_sql": "SELECT \n    ncm.product_line,\n    ncm.failure_mode,\n    COUNT(capa.capa_id) as capa_count,\n    AVG(capa.effectiveness_score) as avg_effectiveness,\n    CASE \n        WHEN AVG(capa.effectiveness_score) >= 4 THEN 'Highly Effective'\n        WHEN AVG(capa.effectiveness_score) >= 3 THEN 'Effective'\n        ELSE 'Needs Improvement'\n    END as effectiveness_rating\nFROM non_conformant_materials ncm\nJOIN corrective_actions capa ON ncm.ncm_id = capa.ncm_id\nWHERE ncm.status = 'Closed'\n    AND capa.status = 'Completed'\nGROUP BY ncm.product_line, ncm.failure_mode\nHAVING COUNT(capa.capa_id) > 1\nORDER BY avg_effectiveness DESC, capa_count DESC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    }
  ],
  "performance_comparison": {
    "success_rates": {
      "standard": 1.0,
      "advanced": 1.0
    },
    "average_confidence": {
      "standard": 0.9583333333333334,
      "advanced": 1.0
    },
    "complexity_distribution": {
      "standard": {
        "QueryComplexity.SIMPLE": 5,
        "QueryComplexity.MEDIUM": 1
      },
      "advanced": {
        "QueryComplexity.MEDIUM": 6
      }
    },
    "safety_compliance": {
      "standard": 1.0,
      "advanced": 1.0
    },
    "improvement_metrics": {
      "success_rate_improvement": 0.0,
      "confidence_improvement": 0.043478260869565175
    }
  }
}