{
  "timestamp": "2025-08-29T02:54:09.239706",
  "test_cases": 6,
  "standard_layer_results": [
    {
      "test_id": "supply_chain_001",
      "query": "Show suppliers with delivery performance issues affecting production",
      "generated_sql": "```sql SELECT s.supplier_id, s.supplier_name, AVG(dd.ontime_rate) AS average_ontime_rate FROM suppliers s JOIN daily_deliveries dd ON s.supplier_id = dd.supplier_id GROUP BY s.supplier_id, s.supplier_name HAVING AVG(dd.ontime_rate) < %s ```",
      "confidence": 0.85,
      "safety_check": true,
      "explanation": " This query joins the suppliers and daily_deliveries tables on the supplier_id field. It then groups the results by supplier_id and supplier_name, and calculates the average ontime_rate for each supplier. The HAVING clause filters out suppliers with an average ontime_rate of 95% or higher, leaving only those suppliers with delivery performance issues. 1.0",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "quality_001",
      "query": "Find products with NCM rates trending above industry standards",
      "generated_sql": "```sql WITH product_ncm_rate AS ( SELECT pd.product_line, AVG(pd.defect_rate) AS avg_defect_rate FROM product_defects pd WHERE pd.defect_type = 'NCM' GROUP BY pd.product_line ), industry_standard AS ( SELECT ib.benchmark_value FROM industry_benchmarks ib WHERE ib.metric_name = 'NCM Rate' AND ib.benchmark_class = 'Industry Standard' ) SELECT pnr.product_line, pnr.avg_defect_rate FROM product_ncm_rate pnr, industry_standard is WHERE pnr.avg_defect_rate > is.benchmark_value ```",
      "confidence": 0.95,
      "safety_check": true,
      "explanation": " This query first creates a CTE (Common Table Expression) named 'product_ncm_rate' that calculates the average NCM defect rate for each product line from the 'product_defects' table. Another CTE 'industry_standard' is created to get the industry standard value for 'NCM Rate' from the 'industry_benchmarks' table. The main SELECT statement then compares the average NCM defect rate of each product line with the industry standard and returns the product lines where the defect rate is higher than the industry standard.",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "production_001",
      "query": "Calculate OEE for critical equipment showing downtime patterns",
      "generated_sql": "```sql SELECT em.equipment_name, em.measurement_date, em.availability_rate * em.performance_rate * em.quality_rate AS oee, em.downtime_hours FROM equipment_metrics em WHERE em.equipment_type = %s ORDER BY em.measurement_date; ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": " This query selects the equipment name, measurement date, calculates the OEE (Overall Equipment Effectiveness) by multiplying the availability rate, performance rate, and quality rate, and selects the downtime hours from the equipment_metrics table where the equipment type is 'Critical'. The results are ordered by the measurement date to show the pattern over time.",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "financial_001",
      "query": "Show cost impact of quality issues by product line",
      "generated_sql": "```sql SELECT product_line, SUM(cost_impact) AS total_cost_impact FROM quality_incidents GROUP BY product_line; ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "This query selects the product line and the sum of the cost impact from the quality_incidents table. It then groups the results by product line, effectively showing the total cost impact of quality issues for each product line.",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "maintenance_001",
      "query": "Find equipment with MTBF below target requiring immediate attention",
      "generated_sql": "```sql SELECT er.equipment_id, em.equipment_name, er.mtbf_hours, mt.target_mtbf FROM equipment_reliability er JOIN equipment_metrics em ON er.equipment_id = em.equipment_id JOIN maintenance_targets mt ON em.equipment_type = mt.equipment_type WHERE er.mtbf_hours < mt.target_mtbf; ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": " This query joins the equipment_reliability, equipment_metrics, and maintenance_targets tables. It then selects the equipment_id, equipment_name, mtbf_hours, and target_mtbf where the mtbf_hours is less than the target_mtbf. This will return all equipment where the Mean Time Between Failures (MTBF) is below the target, indicating that these pieces of equipment require immediate attention.",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "compliance_001",
      "query": "Show CAPA effectiveness for recurring quality issues",
      "generated_sql": "```sql WITH recurring_issues AS ( SELECT product_line, COUNT(incident_id) AS incident_count FROM quality_incidents GROUP BY product_line HAVING COUNT(incident_id) > 1 ), capa_effectiveness AS ( SELECT ncm.product_line, AVG(ca.effectiveness_score) AS avg_effectiveness FROM corrective_actions ca JOIN non_conformant_materials ncm ON ca.ncm_id = ncm.ncm_id GROUP BY ncm.product_line ) SELECT ri.product_line, ri.incident_count, ce.avg_effectiveness FROM recurring_issues ri JOIN capa_effectiveness ce ON ri.product_line = ce.product_line ORDER BY ri.incident_count DESC, ce.avg_effectiveness ASC; ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": " This query first identifies recurring quality issues by counting the number of incidents for each product line and filtering for those with more than one incident. It then calculates the average CAPA effectiveness score for each product line. The final result joins these two sets of data on the product line and orders the results by the number of incidents (descending) and the average effectiveness score (ascending).",
      "complexity": "QueryComplexity.SIMPLE"
    }
  ],
  "advanced_layer_results": [
    {
      "test_id": "supply_chain_001",
      "query": "Show suppliers with delivery performance issues affecting production",
      "generated_sql": "SELECT \n    s.supplier_name,\n    COUNT(d.delivery_id) as total_deliveries,\n    AVG(d.ontime_rate) as avg_delivery_performance,\n    COUNT(ps.schedule_id) as affected_production_schedules\nFROM suppliers s\nJOIN daily_deliveries d ON s.supplier_id = d.supplier_id\nJOIN production_schedule ps ON ps.product_line = d.product_line\nWHERE d.delivery_date >= CURRENT_DATE - INTERVAL '90 days'\n    AND ps.planned_start >= d.delivery_date\n    AND ps.actual_start IS NULL\nGROUP BY s.supplier_id, s.supplier_name\nHAVING AVG(d.ontime_rate) < 0.95\nORDER BY affected_production_schedules DESC, avg_delivery_performance ASC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "quality_001",
      "query": "Find products with NCM rates trending above industry standards",
      "generated_sql": "SELECT \n        product_line,\n        DATE_TRUNC('month', production_date) as month,\n        AVG(defect_rate) as monthly_ncm_rate\n    FROM product_defects\n    WHERE production_date >= CURRENT_DATE - INTERVAL '6 months'\n    AND defect_type = 'NCM'\n    GROUP BY product_line, DATE_TRUNC('month', production_date)\n),\ntrend_analysis AS (\n    SELECT \n        product_line,\n        month,\n        monthly_ncm_rate,\n        LAG(monthly_ncm_rate) OVER (PARTITION BY product_line ORDER BY month) as prev_month_rate\n    FROM monthly_ncm\n),\nindustry_standard AS (\n    SELECT \n        benchmark_value\n    FROM industry_benchmarks\n    WHERE metric_name = 'NCM Rate'\n    AND benchmark_class = 'Industry Average'\n)\nSELECT \n    product_line,\n    COUNT(*) as months_analyzed,\n    AVG(monthly_ncm_rate) as avg_ncm_rate,\n    (monthly_ncm_rate - prev_month_rate) as trend_change,\n    (SELECT benchmark_value FROM industry_standard) as industry_standard\nFROM trend_analysis\nWHERE prev_month_rate IS NOT NULL\n    AND monthly_ncm_rate > prev_month_rate\n    AND monthly_ncm_rate > (SELECT benchmark_value FROM industry_standard)\nGROUP BY product_line, monthly_ncm_rate, prev_month_rate\nHAVING COUNT(*) >= 2\nORDER BY trend_change DESC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.COMPLEX"
    },
    {
      "test_id": "production_001",
      "query": "Calculate OEE for critical equipment showing downtime patterns",
      "generated_sql": "SELECT \n    em.equipment_name,\n    em.equipment_type,\n    AVG(em.availability_rate) as availability,\n    AVG(em.performance_rate) as performance,\n    AVG(em.quality_rate) as quality,\n    (AVG(em.availability_rate) * AVG(em.performance_rate) * AVG(em.quality_rate)) as oee_score,\n    AVG(em.downtime_hours) as avg_downtime_hours,\n    CASE \n        WHEN (AVG(em.availability_rate) * AVG(em.performance_rate) * AVG(em.quality_rate)) >= 0.85 \n        THEN 'World Class'\n        WHEN (AVG(em.availability_rate) * AVG(em.performance_rate) * AVG(em.quality_rate)) >= 0.60 \n        THEN 'Acceptable'\n        ELSE 'Needs Improvement'\n    END as oee_classification\nFROM equipment_metrics em\nWHERE em.measurement_date >= CURRENT_DATE - INTERVAL '30 days'\n    AND em.equipment_type = 'Critical'\nGROUP BY em.equipment_id, em.equipment_name, em.equipment_type\nHAVING AVG(em.downtime_hours) > (SELECT AVG(downtime_hours) FROM equipment_metrics WHERE equipment_type = 'Critical')\nORDER BY oee_score DESC, avg_downtime_hours DESC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "financial_001",
      "query": "Show cost impact of quality issues by product line",
      "generated_sql": "SELECT \n    product_line,\n    COUNT(incident_id) as total_incidents,\n    SUM(cost_impact) as total_cost_impact,\n    AVG(cost_impact) as avg_cost_per_incident\nFROM quality_incidents\nWHERE incident_date >= CURRENT_DATE - INTERVAL '1 year'\nGROUP BY product_line\nORDER BY total_cost_impact DESC",
      "confidence": 0.85,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "maintenance_001",
      "query": "Find equipment with MTBF below target requiring immediate attention",
      "generated_sql": "SELECT \n    em.equipment_name,\n    em.equipment_type,\n    er.mtbf_hours,\n    mt.target_mtbf,\n    (er.mtbf_hours - mt.target_mtbf) as mtbf_variance,\n    CASE \n        WHEN (er.mtbf_hours - mt.target_mtbf) < 0 THEN 'Below Target'\n        ELSE 'On Target'\n    END as mtbf_status\nFROM equipment_reliability er\nJOIN equipment_metrics em ON er.equipment_id = em.equipment_id\nJOIN maintenance_targets mt ON em.equipment_type = mt.equipment_type\nWHERE er.measurement_period >= CURRENT_DATE - INTERVAL '30 days'\n    AND (er.mtbf_hours - mt.target_mtbf) < 0\nORDER BY mtbf_variance ASC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "compliance_001",
      "query": "Show CAPA effectiveness for recurring quality issues",
      "generated_sql": "SELECT \n    ncm.product_line,\n    ncm.failure_mode,\n    COUNT(DISTINCT ncm.ncm_id) as incident_count,\n    AVG(ca.effectiveness_score) as avg_effectiveness_score,\n    COUNT(DISTINCT ca.capa_id) as capa_count\nFROM non_conformant_materials ncm\nJOIN corrective_actions ca ON ncm.ncm_id = ca.ncm_id\nWHERE ncm.incident_date >= CURRENT_DATE - INTERVAL '1 year'\nGROUP BY ncm.product_line, ncm.failure_mode\nHAVING COUNT(DISTINCT ncm.ncm_id) > 1\nORDER BY avg_effectiveness_score ASC, incident_count DESC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    }
  ],
  "performance_comparison": {
    "success_rates": {
      "standard": 1.0,
      "advanced": 1.0
    },
    "average_confidence": {
      "standard": 0.9666666666666667,
      "advanced": 0.975
    },
    "complexity_distribution": {
      "standard": {
        "QueryComplexity.SIMPLE": 5,
        "QueryComplexity.MEDIUM": 1
      },
      "advanced": {
        "QueryComplexity.MEDIUM": 4,
        "QueryComplexity.COMPLEX": 1,
        "QueryComplexity.SIMPLE": 1
      }
    },
    "safety_compliance": {
      "standard": 1.0,
      "advanced": 1.0
    },
    "improvement_metrics": {
      "success_rate_improvement": 0.0,
      "confidence_improvement": 0.008620689655172382
    }
  }
}