name: SQLMesh CI/CD

on:
  push:
    branches: [main, master]
    paths:
      - "Utilities/SQLMesh/**"
  pull_request:
    branches: [main, master]
    paths:
      - "Utilities/SQLMesh/**"
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  SQLMESH_PROJECT_PATH: "Utilities/SQLMesh"

jobs:
  lint-and-test:
    name: Lint & Test Models
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install SQLMesh
        run: |
          python -m pip install --upgrade pip
          pip install sqlmesh

      - name: Validate SQLMesh project
        working-directory: ${{ env.SQLMESH_PROJECT_PATH }}
        run: |
          echo "Validating SQLMesh configuration..."
          sqlmesh info

      - name: Run SQLMesh tests
        working-directory: ${{ env.SQLMESH_PROJECT_PATH }}
        run: |
          echo "Running unit tests..."
          sqlmesh test --verbose

  # REMOVE THIS STEP - audits run during plan/run
  #  - name: Run SQLMesh audits
  #    working-directory: ${{ env.SQLMESH_PROJECT_PATH }}
  #    run: |
  #      echo "Running data quality audits..."
  #      sqlmesh audit

  plan-dev:
    name: Plan Dev Environment
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install SQLMesh
        run: pip install sqlmesh

      - name: Plan dev environment
        working-directory: ${{ env.SQLMESH_PROJECT_PATH }}
        run: |
          echo "Planning changes for dev environment..."
          sqlmesh plan dev --auto-apply --skip-backfill

      - name: Install SQLMesh
        run: pip install sqlmesh

      - name: Plan dev environment
        working-directory: ${{ env.SQLMESH_PROJECT_PATH }}
        run: |
          echo "Planning changes for dev environment..."
          sqlmesh plan dev --no-prompts --skip-backfill

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install SQLMesh
        run: pip install sqlmesh

      - name: Plan and apply production
        working-directory: ${{ env.SQLMESH_PROJECT_PATH }}
        run: |
          echo "Deploying to production..."
          sqlmesh plan --auto-apply --no-prompts

      - name: Create SQLMesh Plan # ‚Üê ADD THIS STEP
        working-directory: ${{ env.SQLMESH_PROJECT_PATH }}
        run: |
          sqlmesh plan --auto-apply --create-from prod --no-prompts

      - name: Run SQLMesh Models
        working-directory: ${{ env.SQLMESH_PROJECT_PATH }}
        run: sqlmesh run

      - name: Generate lineage report
        working-directory: ${{ env.SQLMESH_PROJECT_PATH }}
        run: |
          echo "Generating lineage DAG..."
          sqlmesh dag --file lineage.svg || true

      - name: Upload lineage artifact
        uses: actions/upload-artifact@v4
        with:
          name: lineage-dag
          path: ${{ env.SQLMESH_PROJECT_PATH }}/lineage.svg
          if-no-files-found: ignore
