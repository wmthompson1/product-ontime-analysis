name: SQLMesh CI

on:
  pull_request:
    branches: ["**"]
    paths:
      - 'Utilities/SQLMesh/**'
      - '.github/workflows/sqlmesh-ci.yml'
  push:
    branches:
      - main
      - develop
      - 'feature/add-sqlmesh-*'
    paths:
      - 'Utilities/SQLMesh/**'
      - '.github/workflows/sqlmesh-ci.yml'

permissions:
  contents: read

jobs:
  validate:
    name: Validate SQLMesh Configuration
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Utilities/SQLMesh
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'Utilities/SQLMesh/requirements.txt'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install sqlglot duckdb
      
      - name: Validate SQLMesh configuration
        run: |
          sqlmesh plan --dry-run -p models

  test:
    name: Test SQLMesh Models
    runs-on: ubuntu-latest
    needs: validate
    defaults:
      run:
        working-directory: Utilities/SQLMesh
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'Utilities/SQLMesh/requirements.txt'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install sqlglot duckdb
      
      - name: Run SQLMesh tests
        run: |
          sqlmesh test -p models

  run:
    name: Run SQLMesh Models
    runs-on: ubuntu-latest
    needs: test
    defaults:
      run:
        working-directory: Utilities/SQLMesh
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'Utilities/SQLMesh/requirements.txt'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install sqlglot duckdb

      - name: Run SQLMesh models
        run: |
          sqlmesh run -p models

      - name: Upload DuckDB artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sqlmesh-duckdb-output
          path: Utilities/SQLMesh/*.duckdb
          retention-days: 7
