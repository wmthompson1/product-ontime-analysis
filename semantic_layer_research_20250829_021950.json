{
  "timestamp": "2025-08-29T02:16:57.513298",
  "test_cases": 6,
  "standard_layer_results": [
    {
      "test_id": "supply_chain_001",
      "query": "Show suppliers with delivery performance issues affecting production",
      "generated_sql": "```sql SELECT s.supplier_id, s.supplier_name, AVG(dd.ontime_rate) AS average_ontime_rate FROM suppliers s JOIN daily_deliveries dd ON s.supplier_id = dd.supplier_id GROUP BY s.supplier_id, s.supplier_name HAVING AVG(dd.ontime_rate) < %s ORDER BY average_ontime_rate ASC LIMIT %s; ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": " This query joins the suppliers and daily_deliveries tables on the supplier_id field. It then groups the results by supplier_id and supplier_name, and calculates the average ontime_rate for each supplier. The HAVING clause filters out suppliers with an average ontime_rate of 95% or higher, as per the industry standard for On-Time Delivery (OTD). The results are ordered by average_ontime_rate in ascending order, so suppliers with the worst delivery performance are listed first. The query is limited to the top 100 results to prevent resource exhaustion.",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "quality_001",
      "query": "Find products with NCM rates trending above industry standards",
      "generated_sql": "```sql WITH product_ncm_rate AS ( SELECT pd.product_line, AVG(pd.defect_rate) AS avg_defect_rate FROM product_defects pd WHERE pd.defect_type = 'NCM' GROUP BY pd.product_line ), industry_standard AS ( SELECT ib.benchmark_value FROM industry_benchmarks ib WHERE ib.metric_name = 'NCM Rate' AND ib.benchmark_class = 'Industry Average' ) SELECT pnr.product_line, pnr.avg_defect_rate FROM product_ncm_rate pnr, industry_standard is WHERE pnr.avg_defect_rate > is.benchmark_value ORDER BY pnr.avg_defect_rate DESC LIMIT %s; ```",
      "confidence": 0.85,
      "safety_check": true,
      "explanation": " This query first calculates the average NCM defect rate for each product line in the `product_ncm_rate` CTE. It then gets the industry standard for NCM Rate from the `industry_benchmarks` table in the `industry_standard` CTE. The main SELECT statement then compares the average NCM rate for each product line with the industry standard, and returns the product lines where the NCM rate is higher than the industry standard. The results are ordered in descending order of the NCM rate, and limited to the top 100 product lines. 0.9 MEDIUM",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "production_001",
      "query": "Calculate OEE for critical equipment showing downtime patterns",
      "generated_sql": "```sql SELECT em.equipment_name, em.measurement_date, em.availability_rate * em.performance_rate * em.quality_rate AS oee, em.downtime_hours FROM equipment_metrics AS em WHERE em.equipment_type = %s ORDER BY em.measurement_date; ```",
      "confidence": 0.85,
      "safety_check": true,
      "explanation": " This query selects the equipment name, measurement date, calculates the OEE (Overall Equipment Effectiveness) by multiplying the availability rate, performance rate, and quality rate, and also selects the downtime hours from the equipment_metrics table where the equipment type is 'Critical'. The results are ordered by the measurement date to show the pattern over time. 1.0",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "financial_001",
      "query": "Show cost impact of quality issues by product line",
      "generated_sql": "```sql SELECT product_line, SUM(cost_impact) AS total_cost_impact FROM non_conformant_materials GROUP BY product_line; ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "This query sums up the cost impact of all quality issues (non-conformant materials) for each product line. The GROUP BY clause is used to separate the data by product line, and the SUM function is used to add up the cost impact for each group.",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "maintenance_001",
      "query": "Find equipment with MTBF below target requiring immediate attention",
      "generated_sql": "```sql SELECT er.equipment_id, em.equipment_name, er.mtbf_hours, er.target_mtbf FROM equipment_reliability er JOIN equipment_metrics em ON er.equipment_id = em.equipment_id WHERE er.mtbf_hours < er.target_mtbf; ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": " This query joins the equipment_reliability table with the equipment_metrics table on the equipment_id. It then selects the equipment_id, equipment_name, mtbf_hours, and target_mtbf where the mtbf_hours is less than the target_mtbf. This will return all equipment where the Mean Time Between Failures (MTBF) is below the target, indicating that these pieces of equipment require immediate attention.",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "compliance_001",
      "query": "Show CAPA effectiveness for recurring quality issues",
      "generated_sql": "```sql WITH recurring_issues AS ( SELECT ncm_id, COUNT(capa_id) AS capa_count FROM corrective_actions GROUP BY ncm_id HAVING COUNT(capa_id) > 1 ), capa_effectiveness AS ( SELECT ncm_id, AVG(effectiveness_score) AS avg_effectiveness FROM corrective_actions WHERE ncm_id IN (SELECT ncm_id FROM recurring_issues) GROUP BY ncm_id ) SELECT ncm_id, avg_effectiveness FROM capa_effectiveness ORDER BY avg_effectiveness DESC; ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": " This query first identifies the recurring quality issues by counting the number of CAPA (Corrective And Preventive Actions) associated with each NCM (Non-Conformant Material) incident. It considers an issue as recurring if there is more than one CAPA associated with it. Then, it calculates the average effectiveness of the CAPAs for these recurring issues. The final result is a list of recurring NCM incidents and their corresponding average CAPA effectiveness scores, ordered in descending order of effectiveness.",
      "complexity": "QueryComplexity.SIMPLE"
    }
  ],
  "advanced_layer_results": [
    {
      "test_id": "supply_chain_001",
      "query": "Show suppliers with delivery performance issues affecting production",
      "generated_sql": "SELECT \n    s.supplier_name,\n    COUNT(d.delivery_id) as total_deliveries,\n    AVG(d.ontime_rate) as avg_delivery_performance,\n    COUNT(ps.schedule_id) as affected_production_schedules\nFROM suppliers s\nJOIN daily_deliveries d ON s.supplier_id = d.supplier_id\nJOIN production_schedule ps ON d.delivery_date = ps.planned_start AND d.actual_quantity < ps.target_quantity\nWHERE d.delivery_date >= CURRENT_DATE - INTERVAL '90 days'\nGROUP BY s.supplier_id, s.supplier_name\nHAVING AVG(d.ontime_rate) < 0.95\nORDER BY affected_production_schedules DESC, avg_delivery_performance ASC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "quality_001",
      "query": "Find products with NCM rates trending above industry standards",
      "generated_sql": "SELECT \n    pq.product_line,\n    AVG(pq.defect_rate) as avg_ncm_rate,\n    ib.benchmark_value as industry_standard,\n    COUNT(*) as months_analyzed,\n    (AVG(pq.defect_rate) - ib.benchmark_value) as trend_over_standard\nFROM production_quality pq\nJOIN industry_benchmarks ib ON ib.metric_name = 'NCM Rate'\nWHERE pq.production_date >= CURRENT_DATE - INTERVAL '6 months'\n    AND ib.industry_sector = %s\nGROUP BY pq.product_line, ib.benchmark_value\nHAVING AVG(pq.defect_rate) > ib.benchmark_value\nORDER BY trend_over_standard DESC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "production_001",
      "query": "Calculate OEE for critical equipment showing downtime patterns",
      "generated_sql": "SELECT \n    em.equipment_name,\n    em.equipment_type,\n    AVG(em.availability_rate) as availability,\n    AVG(em.performance_rate) as performance,\n    AVG(em.quality_rate) as quality,\n    (AVG(em.availability_rate) * AVG(em.performance_rate) * AVG(em.quality_rate)) as oee_score,\n    AVG(em.downtime_hours) as avg_downtime_hours,\n    COUNT(fe.failure_id) as failure_count\nFROM equipment_metrics em\nLEFT JOIN failure_events fe ON em.equipment_id = fe.equipment_id\nWHERE em.measurement_date >= CURRENT_DATE - INTERVAL '30 days'\n    AND em.equipment_type = 'Critical'\nGROUP BY em.equipment_id, em.equipment_name, em.equipment_type\nHAVING COUNT(fe.failure_id) > 1\nORDER BY oee_score ASC, avg_downtime_hours DESC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "financial_001",
      "query": "Show cost impact of quality issues by product line",
      "generated_sql": "SELECT \n    pd.product_line,\n    SUM(pd.defect_count) as total_defects,\n    AVG(pd.defect_rate) as avg_defect_rate,\n    SUM(ncm.cost_impact) as total_cost_impact\nFROM product_defects pd\nJOIN non_conformant_materials ncm ON pd.product_line = ncm.product_line\nWHERE pd.production_date >= CURRENT_DATE - INTERVAL '1 year'\nGROUP BY pd.product_line\nORDER BY total_cost_impact DESC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "maintenance_001",
      "query": "Find equipment with MTBF below target requiring immediate attention",
      "generated_sql": "SELECT \n    em.equipment_name,\n    er.mtbf_hours,\n    er.target_mtbf,\n    er.failure_count,\n    er.operating_hours,\n    er.reliability_score,\n    CASE \n        WHEN er.mtbf_hours < er.target_mtbf THEN 'Below Target'\n        ELSE 'On Target'\n    END as mtbf_status\nFROM equipment_reliability er\nJOIN equipment_metrics em ON er.equipment_id = em.equipment_id\nWHERE er.measurement_period >= CURRENT_DATE - INTERVAL '30 days'\n    AND er.mtbf_hours < er.target_mtbf\nORDER BY er.mtbf_hours ASC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "compliance_001",
      "query": "Show CAPA effectiveness for recurring quality issues",
      "generated_sql": "SELECT \n    ncm.product_line,\n    ncm.failure_mode,\n    COUNT(capa.capa_id) as capa_count,\n    AVG(capa.effectiveness_score) as avg_effectiveness_score,\n    CASE \n        WHEN AVG(capa.effectiveness_score) >= 4 THEN 'Highly Effective'\n        WHEN AVG(capa.effectiveness_score) >= 3 THEN 'Effective'\n        ELSE 'Needs Improvement'\n    END as effectiveness_rating\nFROM non_conformant_materials ncm\nJOIN corrective_actions capa ON ncm.ncm_id = capa.ncm_id\nWHERE ncm.status = 'Closed'\n    AND capa.status = 'Completed'\nGROUP BY ncm.product_line, ncm.failure_mode\nHAVING COUNT(capa.capa_id) > 1\nORDER BY avg_effectiveness_score DESC, capa_count DESC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    }
  ],
  "performance_comparison": {
    "success_rates": {
      "standard": 1.0,
      "advanced": 1.0
    },
    "average_confidence": {
      "standard": 0.9500000000000001,
      "advanced": 1.0
    },
    "complexity_distribution": {
      "standard": {
        "QueryComplexity.SIMPLE": 6
      },
      "advanced": {
        "QueryComplexity.MEDIUM": 6
      }
    },
    "safety_compliance": {
      "standard": 1.0,
      "advanced": 1.0
    },
    "improvement_metrics": {
      "success_rate_improvement": 0.0,
      "confidence_improvement": 0.05263157894736835
    }
  }
}