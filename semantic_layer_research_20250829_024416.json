{
  "timestamp": "2025-08-29T02:41:08.393614",
  "test_cases": 6,
  "standard_layer_results": [
    {
      "test_id": "supply_chain_001",
      "query": "Show suppliers with delivery performance issues affecting production",
      "generated_sql": "```sql SELECT s.supplier_id, s.supplier_name, AVG(dd.ontime_rate) AS average_ontime_rate FROM suppliers s JOIN daily_deliveries dd ON s.supplier_id = dd.supplier_id GROUP BY s.supplier_id, s.supplier_name HAVING AVG(dd.ontime_rate) < %s ORDER BY average_ontime_rate ASC; ```",
      "confidence": 0.85,
      "safety_check": true,
      "explanation": " This query joins the suppliers and daily_deliveries tables on the supplier_id. It then groups the results by supplier_id and supplier_name, and calculates the average ontime_rate for each supplier. The HAVING clause filters out suppliers with an average ontime_rate of 95% or higher, as per the industry standard. The results are ordered by average_ontime_rate in ascending order, so suppliers with the worst delivery performance appear first. 1.0",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "quality_001",
      "query": "Find products with NCM rates trending above industry standards",
      "generated_sql": "```sql WITH product_ncm_rate AS ( SELECT pd.product_line, AVG(pd.defect_rate) AS avg_defect_rate FROM product_defects pd WHERE pd.defect_type = 'NCM' GROUP BY pd.product_line ), industry_standard AS ( SELECT ib.benchmark_value FROM industry_benchmarks ib WHERE ib.metric_name = 'NCM Rate' AND ib.benchmark_class = 'Industry Standard' ) SELECT pnr.product_line, pnr.avg_defect_rate FROM product_ncm_rate pnr, industry_standard is WHERE pnr.avg_defect_rate > is.benchmark_value; ```",
      "confidence": 0.9,
      "safety_check": true,
      "explanation": " This query first creates a subquery (product_ncm_rate) that calculates the average defect rate for each product line where the defect type is 'NCM'. Then, it creates another subquery (industry_standard) that retrieves the industry standard value for 'NCM Rate'. Finally, it selects the product lines from the first subquery where the average defect rate is greater than the industry standard. This query uses a cross join between the two subqueries because there is only one row in the industry_standard subquery, so each row in the product_ncm_rate subquery will be combined with that single row. This allows us to compare each product line's average defect rate with the industry standard. Performance should be reasonable assuming the number of product lines and the number of rows in the industry_benchmarks table are not excessively large. If performance is an issue, consider adding appropriate indexes.",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "production_001",
      "query": "Calculate OEE for critical equipment showing downtime patterns",
      "generated_sql": "```sql SELECT em.equipment_name, em.measurement_date, em.availability_rate * em.performance_rate * em.quality_rate AS oee, em.downtime_hours FROM equipment_metrics AS em WHERE em.equipment_type = %s ORDER BY em.measurement_date; ```",
      "confidence": 0.85,
      "safety_check": true,
      "explanation": " This query selects the equipment name, measurement date, calculates the OEE (Overall Equipment Effectiveness) by multiplying the availability rate, performance rate, and quality rate, and selects the downtime hours from the equipment_metrics table where the equipment type is 'Critical'. The results are ordered by the measurement date to show the pattern over time. 1.0",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "financial_001",
      "query": "Show cost impact of quality issues by product line",
      "generated_sql": "```sql SELECT product_line, SUM(cost_impact) AS total_cost_impact FROM non_conformant_materials GROUP BY product_line ORDER BY total_cost_impact DESC; ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "This query sums up the cost impact of all non-conformant materials (quality issues) for each product line. It then orders the results in descending order of total cost impact, so the product line with the highest cost impact from quality issues will be at the top.",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "maintenance_001",
      "query": "Find equipment with MTBF below target requiring immediate attention",
      "generated_sql": "```sql SELECT er.equipment_id, em.equipment_name, er.mtbf_hours, mt.target_mtbf FROM equipment_reliability er JOIN equipment_metrics em ON er.equipment_id = em.equipment_id JOIN maintenance_targets mt ON em.equipment_type = mt.equipment_type WHERE er.mtbf_hours < mt.target_mtbf; ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": " This query joins the equipment_reliability, equipment_metrics, and maintenance_targets tables. It selects the equipment_id, equipment_name, mtbf_hours, and target_mtbf for each piece of equipment where the actual MTBF (Mean Time Between Failures) is less than the target MTBF. This will return a list of equipment that is failing more frequently than desired, indicating that these pieces of equipment require immediate attention.",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "compliance_001",
      "query": "Show CAPA effectiveness for recurring quality issues",
      "generated_sql": "```sql WITH recurring_issues AS ( SELECT ncm_id, COUNT(capa_id) AS capa_count FROM corrective_actions GROUP BY ncm_id HAVING COUNT(capa_id) > 1 ), capa_effectiveness AS ( SELECT ncm_id, AVG(effectiveness_score) AS avg_effectiveness FROM corrective_actions WHERE ncm_id IN (SELECT ncm_id FROM recurring_issues) GROUP BY ncm_id ) SELECT ncm_id, avg_effectiveness FROM capa_effectiveness ORDER BY avg_effectiveness DESC; ```",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": " This query first identifies recurring quality issues by counting the number of CAPA records associated with each NCM ID in the 'corrective_actions' table. It then calculates the average effectiveness score for each of these recurring issues. The final result is a list of recurring NCM IDs and their associated average CAPA effectiveness scores, ordered from highest to lowest effectiveness.",
      "complexity": "QueryComplexity.SIMPLE"
    }
  ],
  "advanced_layer_results": [
    {
      "test_id": "supply_chain_001",
      "query": "Show suppliers with delivery performance issues affecting production",
      "generated_sql": "SELECT \n    s.supplier_name,\n    COUNT(d.delivery_id) as total_deliveries,\n    AVG(d.ontime_rate) as avg_delivery_performance,\n    COUNT(ps.schedule_id) as affected_production_schedules\nFROM suppliers s\nJOIN daily_deliveries d ON s.supplier_id = d.supplier_id\nJOIN production_schedule ps ON ps.product_line = d.product_line\nWHERE d.delivery_date >= CURRENT_DATE - INTERVAL '90 days'\n    AND ps.planned_start >= d.delivery_date\n    AND ps.actual_start IS NULL\nGROUP BY s.supplier_id, s.supplier_name\nHAVING AVG(d.ontime_rate) < 0.95\nORDER BY affected_production_schedules DESC, avg_delivery_performance ASC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "quality_001",
      "query": "Find products with NCM rates trending above industry standards",
      "generated_sql": "SELECT \n        product_line,\n        DATE_TRUNC('month', production_date) as month,\n        AVG(defect_rate) as monthly_ncm_rate\n    FROM product_defects\n    WHERE defect_type = 'NCM'\n        AND production_date >= CURRENT_DATE - INTERVAL '6 months'\n    GROUP BY product_line, DATE_TRUNC('month', production_date)\n),\nindustry_standard AS (\n    SELECT \n        benchmark_value as ncm_standard\n    FROM industry_benchmarks\n    WHERE metric_name = 'NCM Rate'\n        AND benchmark_class = 'Industry Average'\n),\ntrend_analysis AS (\n    SELECT \n        product_line,\n        month,\n        monthly_ncm_rate,\n        LAG(monthly_ncm_rate) OVER (PARTITION BY product_line ORDER BY month) as prev_month_rate,\n        ncm_standard\n    FROM monthly_ncm, industry_standard\n)\nSELECT \n    product_line,\n    COUNT(*) as months_analyzed,\n    AVG(monthly_ncm_rate) as avg_ncm_rate,\n    (monthly_ncm_rate - prev_month_rate) as trend_change,\n    ncm_standard\nFROM trend_analysis\nWHERE prev_month_rate IS NOT NULL\n    AND monthly_ncm_rate > prev_month_rate\n    AND monthly_ncm_rate > ncm_standard\nGROUP BY product_line, monthly_ncm_rate, prev_month_rate, ncm_standard\nHAVING COUNT(*) >= 2\nORDER BY trend_change DESC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.COMPLEX"
    },
    {
      "test_id": "production_001",
      "query": "Calculate OEE for critical equipment showing downtime patterns",
      "generated_sql": "SELECT \n    em.equipment_name,\n    em.equipment_type,\n    AVG(em.availability_rate) as availability,\n    AVG(em.performance_rate) as performance,\n    AVG(em.quality_rate) as quality,\n    (AVG(em.availability_rate) * AVG(em.performance_rate) * AVG(em.quality_rate)) as oee_score,\n    AVG(em.downtime_hours) as avg_downtime_hours,\n    COUNT(fe.failure_id) as failure_count\nFROM equipment_metrics em\nLEFT JOIN failure_events fe ON em.equipment_id = fe.equipment_id\nWHERE em.measurement_date >= CURRENT_DATE - INTERVAL '30 days'\n    AND em.equipment_type = 'Critical'\nGROUP BY em.equipment_id, em.equipment_name, em.equipment_type\nHAVING COUNT(fe.failure_id) > 0\nORDER BY oee_score ASC, avg_downtime_hours DESC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "financial_001",
      "query": "Show cost impact of quality issues by product line",
      "generated_sql": "SELECT \n    pd.product_line,\n    COUNT(pd.defect_id) as total_defects,\n    SUM(ncm.cost_impact) as total_cost_impact\nFROM product_defects pd\nJOIN non_conformant_materials ncm ON pd.product_line = ncm.product_line\nWHERE pd.defect_type = 'NCM'\nGROUP BY pd.product_line\nORDER BY total_cost_impact DESC",
      "confidence": 0.85,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.SIMPLE"
    },
    {
      "test_id": "maintenance_001",
      "query": "Find equipment with MTBF below target requiring immediate attention",
      "generated_sql": "SELECT \n    em.equipment_name,\n    em.equipment_type,\n    er.mtbf_hours,\n    mt.target_mtbf,\n    (er.mtbf_hours - mt.target_mtbf) as mtbf_gap,\n    CASE \n        WHEN (er.mtbf_hours - mt.target_mtbf) < 0 THEN 'Below Target'\n        ELSE 'On Target'\n    END as status\nFROM equipment_reliability er\nJOIN equipment_metrics em ON er.equipment_id = em.equipment_id\nJOIN maintenance_targets mt ON em.equipment_type = mt.equipment_type\nWHERE er.measurement_period >= CURRENT_DATE - INTERVAL '30 days'\n    AND (er.mtbf_hours - mt.target_mtbf) < 0\nORDER BY mtbf_gap ASC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    },
    {
      "test_id": "compliance_001",
      "query": "Show CAPA effectiveness for recurring quality issues",
      "generated_sql": "SELECT \n    ncm.product_line,\n    ncm.failure_mode,\n    COUNT(capa.capa_id) as capa_count,\n    AVG(capa.effectiveness_score) as avg_effectiveness,\n    CASE \n        WHEN AVG(capa.effectiveness_score) >= 4 THEN 'Highly Effective'\n        WHEN AVG(capa.effectiveness_score) >= 3 THEN 'Effective'\n        ELSE 'Needs Improvement'\n    END as effectiveness_rating\nFROM non_conformant_materials ncm\nJOIN corrective_actions capa ON ncm.ncm_id = capa.ncm_id\nWHERE ncm.status = 'Closed'\n    AND capa.status = 'Completed'\nGROUP BY ncm.product_line, ncm.failure_mode\nHAVING COUNT(capa.capa_id) > 1\nORDER BY avg_effectiveness DESC, capa_count DESC",
      "confidence": 1.0,
      "safety_check": true,
      "explanation": "Extracted SQL from LLM response",
      "complexity": "QueryComplexity.MEDIUM"
    }
  ],
  "performance_comparison": {
    "success_rates": {
      "standard": 1.0,
      "advanced": 1.0
    },
    "average_confidence": {
      "standard": 0.9333333333333332,
      "advanced": 0.975
    },
    "complexity_distribution": {
      "standard": {
        "QueryComplexity.SIMPLE": 5,
        "QueryComplexity.MEDIUM": 1
      },
      "advanced": {
        "QueryComplexity.MEDIUM": 4,
        "QueryComplexity.COMPLEX": 1,
        "QueryComplexity.SIMPLE": 1
      }
    },
    "safety_compliance": {
      "standard": 1.0,
      "advanced": 1.0
    },
    "improvement_metrics": {
      "success_rate_improvement": 0.0,
      "confidence_improvement": 0.04464285714285723
    }
  }
}